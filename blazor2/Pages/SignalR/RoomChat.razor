@page "/room_chat"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager _navigationManager
@implements IDisposable

@* client  *@

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-3 chat-sidebar p-3">
      <h5>Chat Rooms</h5>
      <button class="btn btn-primary w-100 mb-3" @onclick="AddNewRoom">+ Add Room</button>
      <ul class="list-group">
        
       @foreach(var room in rooms)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                @room.roomName
                <span class="badge bg-primary rounded-pill">0</span>
            </li>
        }
      </ul>
    </div>

    <!-- Chat content -->
    <div class="col-9 p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Room 1</h5>
        <button class="btn btn-danger">Leave Room</button>
      </div>

      <div class="chat-room border rounded bg-white">
        <!-- Message -->
        <div class="chat-message">
          <strong>User1</strong><br>
          Hello everyone!<br>
          <span class="time">10:30 AM</span>
        </div>

        <div class="chat-message text-end">
          <strong>You</strong><br>
          Hi! How are you?<br>
          <span class="time">10:31 AM</span>
        </div>
      </div>

      <!-- Input -->
      <div class="mt-3">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Type your message...">
          <button class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

@code{
    public List<RoomVM> rooms = new List<RoomVM>();
    // kêt clietn tới hub 
    HubConnection _hubConnection;
    protected override async Task OnInitializedAsync()
    {
        // kết nối tới hub
        _hubConnection = new HubConnectionBuilder()
            .WithUrl($"{_navigationManager.ToAbsoluteUri("/roomHub")}") // url hub
            .WithAutomaticReconnect() // tự động kết nối lại nếu mất kết nối
            .Build();
        
        await _hubConnection.StartAsync(); // bắt đầu kết nối


        // lắng nghe sự kiện từ hub
        // client lắng nghe : On + tên sự kiện
        _hubConnection.On<List<RoomVM>>("ReceiveRoomList",async (room)=>{
            rooms = room;
            await InvokeAsync(StateHasChanged); // cập nhật giao diện
        });
    }
    
    public async Task AddNewRoom()
    {
        // gọi phương thức của hub
        // cliet gọi server: Invoke + tên method
        await _hubConnection.InvokeAsync("AddRoom");
        
    }

    public void Dispose()
    {
        _ = _hubConnection.DisposeAsync();
    }
    
}